# Custom Prefect Worker with MCP Integration Dependencies
FROM prefecthq/prefect:3-python3.12

# Set working directory
WORKDIR /workspace

# Copy workspace files and install dependencies via UV
COPY --from=ghcr.io/astral-sh/uv:latest /uv /bin/uv
COPY pyproject.toml uv.lock* ./
COPY services/prefect_worker/pyproject.toml ./services/prefect_worker/
RUN uv sync --frozen --no-install-project --no-dev

# Copy sitecustomize.py for universal Helicone integration
# Uses environment variable proxy approach for automatic OpenAI SDK routing
COPY sitecustomize.py /usr/local/lib/python3.12/site-packages/

# Set the workspace as working directory for flows
WORKDIR /workspace

ENV COGNI_MCP_SSE_URL=http://toolhive:24160/sse

# Default command (will be overridden by docker-compose)
CMD ["prefect", "worker", "start", "--pool", "cogni-pool"] 