{
  "type": "Task",
  "status": "todo",
  "project": "../project-CogniMemorySystem-POC.json",
  "name": "Implement StructuredMemoryBank",
  "description": "Create the core StructuredMemoryBank class responsible for managing MemoryBlocks using Dolt for persistence and LlamaIndex for indexing and retrieval.",
  "phase": "⚙️ Phase 3: Agent + Tool Wiring (Structured Memory)",
  "implementation_details": {
    "target_file": "experiments/src/memory_system/structured_memory_bank.py",
    "test_file": "experiments/src/memory_system/tests/test_structured_memory_bank.py",
    "dependencies": [
      "Dolt connection/writer logic (from Phase 1/2)",
      "LlamaIndex connection/indexing logic (from Phase 1/2)",
      "MemoryBlock Pydantic schema (from Phase 1)",
      "BlockLink Pydantic schema (from Phase 1)",
      "MemoryBlock-to-Node conversion function (from Phase 2)",
      "Node Schema registry logic (from Phase 2)"
    ]
  },
  "action_items": [
    "[x] Define the `StructuredMemoryBank` class structure.",
    "[x] Implement `__init__` to establish connections to Dolt and LlamaIndex (vector store + graph store).",
    "[ ] Implement `create_memory_block(block: MemoryBlock)`:",
    "[ ]   Validate input `block` using Pydantic model.",
    "[ ]   Query `node_schemas` table for latest version (Task 2.0).",
    "[ ]   Set `schema_version` on the block object.",
    "[/]   Write block data to Dolt `memory_blocks` table. (Using `dolt_writer`, needs secure migration - see project-SecureDoltWriteMigration.json)",
    "[ ]   Write links to Dolt `block_links` table.",
    "[/]   Convert block to LlamaIndex Node(s) (Task 2.1).",
    "[/]   Add/update node(s) in LlamaIndex VectorStore and GraphStore.",
    "[/]   Commit changes in Dolt. (Using `dolt_writer`, needs secure migration - see project-SecureDoltWriteMigration.json)",
    "[ ]   (Optional) Store commit hash in `block_proofs` (Phase 7).",
    "[x] Implement `get_memory_block(block_id: str) -> MemoryBlock | None` (Read from Dolt).",
    "[/] Implement `update_memory_block(block_id: str, update_data: dict) -> bool` (Fetch, update, validate, write to Dolt, re-index, commit).",
    "[/] Implement `delete_memory_block(block_id: str) -> bool` (Delete from Dolt, delete from LlamaIndex, commit).",
    "[ ] Implement `query_semantic(query_text: str, top_k: int = 5) -> List[MemoryBlock]` (Query LlamaIndex vector store, retrieve full blocks from Dolt).",
    "[ ] Implement `get_blocks_by_tags(tags: List[str], match_all: bool = True) -> List[MemoryBlock]` (Query Dolt `tags_json` or LlamaIndex metadata).",
    "[ ] Implement `get_forward_links(block_id: str, relation: str | None = None) -> List[BlockLink]` (Query Dolt `block_links` or LlamaIndex graph).",
    "[ ] Implement `get_backlinks(block_id: str, relation: str | None = None) -> List[BlockLink]` (Query Dolt `block_links` or LlamaIndex graph).",
    "[ ] (Optional) Implement chat history fallback methods (`read_history_dicts`, `write_history_dicts`) if desired, potentially reading/writing special `chat_message` MemoryBlocks."
  ],
  "test_criteria": [
    "[ ] See `task-3.6-test-structuredmemorybank.json`.",
    "[ ] Tests demonstrate correct commit/rollback behavior under success and failure conditions."
  ],
  "success_criteria": [
    "[ ] A functional class exists that encapsulates Dolt/LlamaIndex interactions for MemoryBlocks.",
    "[ ] Core CRUD operations on MemoryBlocks are implemented and working.",
    "[ ] Semantic, tag-based, and link-based querying methods are available.",
    "[ ] Writes are atomic (Dolt commit) and trigger indexing."
  ],
  "current_status": "Class structure defined, __init__ implemented. get_memory_block, create_memory_block, update_memory_block implemented and tested (with known atomicity/security issues). delete_memory_block implemented (using new dolt_writer function) and tested (with known atomicity/security issues). Dolt interactions use manual escaping due to doltpy.cli limits; secure migration planned."
} 