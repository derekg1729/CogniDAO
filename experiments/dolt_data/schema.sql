-- Auto-generated from MemoryBlock schema. Do not edit manually.
-- This file is generated by experiments/scripts/generate_dolt_schema.py
-- based on the Pydantic models in experiments/src/memory_system/schemas/.

CREATE TABLE memory_blocks (
  id VARCHAR(255) PRIMARY KEY,
  type VARCHAR(50) NOT NULL,
  schema_version INT NOT NULL ,
  text TEXT NOT NULL ,
  state VARCHAR(50) DEFAULT 'draft' NOT NULL,
  visibility VARCHAR(50) DEFAULT 'internal' NOT NULL,
  block_version INT DEFAULT 1 NOT NULL,
  tags VARCHAR(255) NOT NULL ,
  metadata JSON NOT NULL ,
  links JSON NOT NULL ,
  source_file VARCHAR(255) NOT NULL ,
  source_uri VARCHAR(255) NOT NULL ,
  confidence JSON NOT NULL ,
  created_by VARCHAR(255) NOT NULL ,
  created_at DATETIME NOT NULL ,
  updated_at DATETIME NOT NULL ,
  embedding TEXT NOT NULL ,
  CHECK (type IN ('knowledge', 'task', 'project', 'doc')),
  CHECK (state IN ('draft', 'published', 'archived')),
  CHECK (visibility IN ('internal', 'public', 'restricted'))
);

CREATE INDEX idx_memory_blocks_type_state_visibility 
ON memory_blocks (type, state, visibility);

CREATE TABLE block_links (
  to_id VARCHAR(255) NOT NULL,
  relation VARCHAR(50) NOT NULL,
  CHECK (relation IN ('related_to', 'subtask_of', 'depends_on', 'child_of', 'mentions')),
  FOREIGN KEY (to_id) REFERENCES memory_blocks(id) ON DELETE CASCADE
);

CREATE INDEX idx_block_links_to_id ON block_links (to_id);

CREATE TABLE node_schemas (
  node_type VARCHAR(255) NOT NULL ,
  schema_version INT NOT NULL ,
  json_schema JSON NOT NULL ,
  created_at VARCHAR(255) NOT NULL 
);

CREATE TABLE block_proofs (
  id INTEGER PRIMARY KEY AUTO_INCREMENT,
  block_id VARCHAR(255) NOT NULL,
  commit_hash VARCHAR(255) NOT NULL,
  operation VARCHAR(10) NOT NULL CHECK (operation IN ('create', 'update', 'delete')),
  timestamp DATETIME NOT NULL,
  INDEX block_id_idx (block_id)
);
